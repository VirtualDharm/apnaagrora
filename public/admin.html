<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Casting API Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 10px;
      background: #f9fafc;
    }
    h2 {
      text-align: center;
      color: #007bff;
    }
    section {
      margin-bottom: 25px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    input, button, textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #0056b3;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
    }
    .room-card {
      background: #fff;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .participants {
      background: #f0f8ff;
      border-radius: 6px;
      padding: 8px;
      margin-top: 8px;
    }
    .participant {
      margin-left: 10px;
      padding: 2px 0;
      font-size: 0.95em;
    }
    .stats {
      text-align: right;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>📞 Casting API Admin Panel</h2>

  <section>
    <h3>🧩 Create Room</h3>
    <input id="ownerId" placeholder="Owner ID (optional)" />
    <input id="ttlSeconds" placeholder="TTL seconds (default 3600)" />
    <button id="createRoomBtn">Create Room</button>
    <pre id="createRoomResult"></pre>
  </section>

  <section>
    <h3>📋 Active Rooms</h3>
    <div class="stats">
      <span id="roomCount">Rooms: 0</span> | 
      <span id="totalParticipants">Participants: 0</span>
    </div>
    <button id="listRoomsBtn">Refresh</button>
    <div id="roomsContainer"></div>
  </section>

  <section>
    <h3>🎟️ Create Invite</h3>
    <input id="inviteRoomId" placeholder="Room ID" />
    <input id="inviteeId" placeholder="Invitee ID (optional)" />
    <input id="inviteTtl" placeholder="Invite TTL (default 900s)" />
    <button id="inviteBtn">Create Invite</button>
    <pre id="inviteResult"></pre>
  </section>

  <section>
    <h3>🔐 Generate Token</h3>
    <input id="tokenRoomId" placeholder="Room ID" />
    <input id="tokenUserId" placeholder="User ID" />
    <input id="tokenTtl" placeholder="TTL seconds (default 3600)" />
    <button id="tokenBtn">Generate Token</button>
    <pre id="tokenResult"></pre>
  </section>

  <section>
    <h3>🚫 Revoke Token</h3>
    <input id="revokeJti" placeholder="Token JTI" />
    <button id="revokeBtn">Revoke Token</button>
    <pre id="revokeResult"></pre>
  </section>

  <script>
    const base = location.origin;

    async function request(path, method = "GET", body = null) {
      const opts = { method, headers: { "Content-Type": "application/json" } };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(base + path, opts);
      return res.json();
    }

    const roomsContainer = document.getElementById("roomsContainer");
    const roomCountEl = document.getElementById("roomCount");
    const totalParticipantsEl = document.getElementById("totalParticipants");

    document.getElementById("createRoomBtn").onclick = async () => {
      const ownerId = document.getElementById("ownerId").value || undefined;
      const ttlSeconds = parseInt(document.getElementById("ttlSeconds").value) || undefined;
      const data = await request("/rooms", "POST", { ownerId, ttlSeconds });
      document.getElementById("createRoomResult").textContent = JSON.stringify(data, null, 2);
      loadRooms();
    };

    document.getElementById("inviteBtn").onclick = async () => {
      const roomId = document.getElementById("inviteRoomId").value;
      const inviteeId = document.getElementById("inviteeId").value || undefined;
      const ttlSeconds = parseInt(document.getElementById("inviteTtl").value) || undefined;
      const data = await request(`/rooms/${roomId}/invite`, "POST", { inviteeId, ttlSeconds });
      document.getElementById("inviteResult").textContent = JSON.stringify(data, null, 2);
    };

    document.getElementById("tokenBtn").onclick = async () => {
      const roomId = document.getElementById("tokenRoomId").value;
      const userId = document.getElementById("tokenUserId").value;
      const ttlSeconds = parseInt(document.getElementById("tokenTtl").value) || undefined;
      const data = await request("/token", "POST", { roomId, userId, ttlSeconds });
      document.getElementById("tokenResult").textContent = JSON.stringify(data, null, 2);
    };

    document.getElementById("revokeBtn").onclick = async () => {
      const jti = document.getElementById("revokeJti").value;
      const data = await request(`/token/${jti}/revoke`, "POST");
      document.getElementById("revokeResult").textContent = JSON.stringify(data, null, 2);
    };

    document.getElementById("listRoomsBtn").onclick = loadRooms;

    async function loadRooms() {
      const data = await request("/rooms");
      if (!data.ok) return;

      const rooms = data.rooms;
      roomCountEl.textContent = `Rooms: ${rooms.length}`;
      const totalParticipants = rooms.reduce((sum, r) => sum + (r.participants?.length || 0), 0);
      totalParticipantsEl.textContent = `Participants: ${totalParticipants}`;

      roomsContainer.innerHTML = rooms.map(r => `
        <div class="room-card">
          <b>Room ID:</b> ${r.id}<br/>
          <b>Owner:</b> ${r.ownerId || "—"}<br/>
          <b>Created:</b> ${new Date(r.createdAt).toLocaleString()}<br/>
          <b>TTL:</b> ${r.ttlSeconds}s<br/>
          <b>Participants (${r.participants.length}):</b>
          <div class="participants">
            ${r.participants.length === 0
              ? "<em>No participants currently</em>"
              : r.participants.map(p => `
                  <div class="participant">
                    🧍 <b>${p.userId}</b> 
                    (${p.role || "participant"}) 
                    <small>joined: ${new Date(p.joinedAt).toLocaleTimeString()}</small>
                  </div>`).join("")
            }
          </div>
        </div>
      `).join("");
    }

    // Auto-refresh every 10s
    setInterval(loadRooms, 10000);
    loadRooms();
  </script>
</body>
</html>
